# Лучшие практики создания агентов - Реализация

Этот документ описывает реализацию лучших практик создания AI-агентов в проекте.

## Принципы, которые были применены

### 1. Четкое разделение ролей и ответственности

**System Prompt** (`data/system_prompt.txt`):
- Определяет КАК агент должен общаться
- Содержит личность, характер, стиль общения
- Не содержит фактов о компании или услугах

**Static Context** (`data/static_context.txt`):
- Содержит миссию компании и описание услуг
- Информация, которая не меняется часто
- Структурирована с четкими разделами

**Dynamic Context** (`data/dynamic_context.txt`):
- Актуальные цены, тарифы, сроки
- Информация, которая меняется регулярно
- Имеет приоритет для цен и сроков

### 2. Явные инструкции по обработке информации

В `prompts.py` реализованы:
- Четкая иерархия источников знаний с приоритетами
- Явные правила разрешения противоречий
- Четкие инструкции по эскалации к менеджеру
- Правила форматирования ответов

### 3. Структурированные правила поведения

System prompt содержит:
- Раздел "РОЛЬ И НАЗНАЧЕНИЕ" - четкое определение роли
- Раздел "ЛИЧНОСТЬ И ХАРАКТЕР" - описание личности агента
- Раздел "СТИЛЬ ОБЩЕНИЯ" - конкретные примеры и правила
- Раздел "ПРАВИЛА ВЗАИМОДЕЙСТВИЯ" - что делать и чего не делать
- Раздел "ОБРАБОТКА ИНФОРМАЦИИ" - как работать с источниками
- Раздел "ФОРМАТИРОВАНИЕ ОТВЕТОВ" - правила форматирования
- Раздел "ЭСКАЛАЦИЯ К МЕНЕДЖЕРУ" - четкие условия эскалации

### 4. Приоритизация источников знаний

Порядок приоритета:
1. **Knowledge Cards** - для фактов (высший приоритет)
2. **Dynamic Context** - для цен и сроков (высший приоритет)
3. **Static Context** - общая информация о компании
4. **Dialogue Context** - контекст диалога

**Примечание:** FAQ больше не используется как источник знаний в промпте. FAQ используется только для точных совпадений (exact match) - если вопрос точно совпадает с FAQ, ответ дается напрямую без использования LLM (оптимизация стоимости и надежности).

### 5. Обработка неопределенности

Четкие правила:
- Если информации нет → эскалация
- Если есть сомнения → эскалация
- Если противоречия неразрешимы → эскалация
- Строгая фраза для эскалации: "По данному вопросу вам в ближайшее время ответит наш менеджер."

### 6. Форматирование ответов

Правила:
- Кратко и по делу
- Списки с дефисом '-' (без markdown)
- Максимум 950 символов
- Структурированная подача информации

### 7. Минимизация галлюцинаций

Реализовано через:
- Явный запрет на выдумывание фактов
- Использование только предоставленных источников
- Четкие инструкции "НЕ угадывай"
- Эскалация при недостатке информации

## Структура промпта

Промпт структурирован следующим образом:

```
1. System Prompt (роль, личность, стиль)
2. Hardcoded System Part (критические правила)
3. Источники знаний (структурированные блоки)
   - Static Context
   - Dynamic Context
   - Knowledge Cards
   - FAQ
   - Dialogue Context
4. Задача (входящий вопрос)
5. Инструкции (шаги для выполнения)
```

## Улучшения в коде

### `prompts.py`
- Улучшенная структура промпта с четкими разделами
- Явные инструкции по приоритетам источников
- Четкие правила эскалации
- Улучшенная документация

### `responder.py`
- Улучшенное форматирование контекстов
- Более структурированный вывод knowledge cards
- Лучшая читаемость контекста диалога
- FAQ используется только для exact match (точных совпадений) без LLM

### Файлы контекстов
- Структурированы с использованием markdown-заголовков
- Четкое разделение на разделы
- Улучшенная читаемость
- Логическая организация информации

## Преимущества новой структуры

1. **Четкость** - агент точно понимает свою роль и ограничения
2. **Надежность** - минимизация галлюцинаций через явные правила
3. **Консистентность** - единообразный стиль общения
4. **Масштабируемость** - легко добавлять новые источники знаний
5. **Поддерживаемость** - понятная структура для разработчиков
6. **Эффективность** - четкие приоритеты источников

## Рекомендации по использованию

1. **Обновление Dynamic Context** - регулярно (при изменении цен/сроков)
2. **Обновление Static Context** - редко (при изменении миссии/услуг)
3. **Обновление System Prompt** - очень редко (при изменении стиля общения)
4. **Knowledge Cards** - автоматически или вручную через админ-панель
5. **FAQ** - через админ-панель при добавлении проверенных ответов

## Соответствие лучшим практикам

✅ Четкое определение роли и ответственности  
✅ Явные инструкции по обработке информации  
✅ Структурированные правила поведения  
✅ Четкие границы и ограничения  
✅ Приоритизация источников знаний  
✅ Обработка неопределенности  
✅ Форматирование ответов  
✅ Эскалация к человеку  
✅ Минимизация галлюцинаций  
✅ Поддерживаемость и масштабируемость

